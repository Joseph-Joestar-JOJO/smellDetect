<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="UTF-8">
    <th:block th:include="include :: header('百度ECharts')" />
    <link rel="stylesheet" href="/SyntaxHighlighter/styles/shCore.css">
    <link rel="stylesheet" href="/SyntaxHighlighter/styles/shThemeDefault.css">


</head>

<div class="container-div">
    <div class="row">
        <div class="col-sm-12 select-table table-striped" >
            <div style="height: 200px;overflow: scroll">
            <table id="bootstrap-table"></table>
            </div>
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <a id="filename"></a>
                            </div>
                            <div id="codeMain" class="ibox-content" style="height: 500px;overflow: scroll">

                                <div id = "codePre">

                                    <pre id="content" class="brush: java;highlight: [14,15,16,17,18]">

    </pre>

                                </div>

                            </div>
                        </div>
                    </div>

                </div>
    </div>
</div>
<div th:include="include :: footer"></div>

<script type="text/javascript">
$(function() {

    var infoList = list[0].smellinfo.split("\n");
    var start = parseInt(infoList[0])+1;
    var end = parseInt(infoList[1])+1;
    var lineFirst = start;
    if(end==-1){
        end = 2000;
    }
    var array = new Array();
    for(var i = start ,j=0; i <= end; i++ ,j++)
    {
        array[j] = i;
    }
    var finalList = "["+array+"]";
    var redList = new Array();
    var blueList = new Array();
    var purpleList = new Array();

    var info="";
    if (list[0].catalog == "blob" || list[0].catalog == "long Method")
    {
        var highlight = infoList[2];
        var subHigh = highlight.split(";");
        var redIndex = 0;
        var blueIndex = 0;
        var purpleIndex = 0;
        var i;
        lineFirst = parseInt(subHigh[0].split(":")[0].split("/")[0])+1;
        for (var k=0; k<subHigh.length; k++)
        {
            var subsubHigh = subHigh[k].split(":");
            var line = subsubHigh[0];
            var catalog = subsubHigh[1];
            var lineStart = parseInt(line.split("/")[0])+1;
            var lineEnd = parseInt(line.split("/")[1])+1;
            if (lineEnd == -1) lineEnd = 2000;
            if(catalog == -1)
            {
                for(i = lineStart ; i <= lineEnd; i++)
                {
                    redList[redIndex++] = i;
                }
            }
            if(catalog == 1)
            {
                for(i = lineStart ; i <= lineEnd; i++)
                {
                    blueList[blueIndex++] = i;
                }
            }
            if(catalog == 2)
            {
                for(i = lineStart; i <= lineEnd; i++)
                {
                    purpleList[purpleIndex++] = i;
                }
            }

        }

        var finalred = ";highlight3:["+redList+"]";
        var finalblue = ";highlight1:["+blueList+"]";
        var finalpurple = ";highlight2:["+purpleList+"]";
        var final = finalred + finalblue + finalpurple;
    }else if(list[0].catalog == "feature Envy"){
        info += "建议修改以下高亮代码";
        info += "\n";
        info = "过分依赖的类："+infoList[2]+" 可单击查看";
    }else if(list[0].catalog == "promiscuous Package")
    {
        if(infoList.length >= 2){
            info += "建议修改以下类文件";
        }

        for (i=2; i<infoList.length; i++)
        {
            info += "\n";
            info += infoList[i]+".java";
        }
    }
    else
    {
        info += "建议修改以下高亮代码"+"\n";
        info += "过分依赖的包："+infoList[2];
    }

    jQuery("#codePre").html("<div><pre id='content'></pre></div>");
    jQuery("#codePre").removeAttr("style","");
    jQuery("#codePre").removeAttr("class","");

    if(list[0].catalog == "blob" || list[0].catalog == "long Method")
    {
        $("#content").attr("class","brush: java;"+final);
    }
    else
    {
        $("#content").attr("class","brush: java;highlight:"+finalList+final);
    }
    document.getElementById("filename").innerText = "提示：单击上方异味列表中的行，可查询该异味详情和重构建议。单击 + 可查看评论\n"+"异味源: "+list[0].filepath +"具体信息请留意下方提示\n"+""+'\n'+info;
    document.getElementById("content").innerText = list[0].content;

    if (list[0].catalog == "feature Envy")
    {
        var c = list[0].content.split("\n<>\n");
        document.getElementById("content").innerText = c[0];
        document.getElementById("filename").setAttribute("href",'/system/showCode2?url='+url+'&commit='+commit+'&filePath='+infoList[2]+'&name='+list[0].name);
        document.getElementById("filename").setAttribute("target","_blank");
    }

    if(list[0].catalog != "promiscuous Package")
    {
        SyntaxHighlighter.defaults['toolbar'] = false;
        SyntaxHighlighter.config.tagName = 'pre';       //可以更改解析的默认Tag。
        SyntaxHighlighter.config.bloggerMode = true;
        SyntaxHighlighter.config.stripBrs = true;
        SyntaxHighlighter.highlight();
        var mainContainer = $('#codeMain');
        var scrollToContainer = $('#'+lineFirst+'');
        window.scrollTo(0, document.documentElement.scrollHeight);
        mainContainer.animate({
            scrollTop: scrollToContainer.offset().top - mainContainer.offset().top + mainContainer.scrollTop()
        }, 100);
    }else {
        var highlight = infoList[0];
        var subHigh = highlight.split(";");
        var redList = new Array();
        var blueList = new Array();
        var purpleList = new Array();
        var redIndex = 0;
        var blueIndex = 0;
        var purpleIndex = 0;
        for (var k=0; k<subHigh.length; k++)
        {
            var subsubHigh = subHigh[k].split(":");
            var fileName = subsubHigh[0];
            var catalog = subsubHigh[1];
            if(catalog == -1)
            {
                redList[redIndex++] = fileName;
            }
            if(catalog == 1)
            {
                blueList[blueIndex++] = fileName;
            }
            if(catalog == 2)
            {
                purpleList[purpleIndex++] = fileName;
            }
        }
        // var obj = document.getElementById('codeMain');
        // obj.parentNode.removeChild(obj);
        var content = "平台已将包中的文件分为以下类别：\n";
        if (redList.length > 0)
        {
            for (i=0; i<redList.length; i++)
            {
                content += redList[i]+"\n";
            }
            content += "=====================\n";
        }
        if (blueList.length > 0)
        {
            for (i=0; i<blueList.length; i++)
            {
                content += blueList[i]+"\n";
            }
            content += "=====================\n";
        }
        if (purpleList.length > 0)
        {
            for (i=0; i<purpleList.length; i++)
            {
                content += purpleList[i]+"\n";
            }
            content += "=====================\n";
        }
        document.getElementById("content").innerText = content;
    }
});
</script>
<script type="text/javascript" src="/SyntaxHighlighter/scripts/XRegExp.js"></script>
<script type="text/javascript" src="/SyntaxHighlighter/scripts/shCore.js"></script>
<script type="text/javascript" src="/SyntaxHighlighter/scripts/shBrushJava.js"></script>
<script type="text/javascript" src="/SyntaxHighlighter/scripts/shBrushJScript.js"></script>
<script type="text/javascript" src="/SyntaxHighlighter/scripts/shBrushSql.js"></script>

<script th:inline="javascript">
    var url=[[${url}]];
    var commit=[[${commit}]];
    var catalog=[[${catalog}]];
    var list=[[${list}]];
    var list2=[[${list2}]];
    var filename = list[0].filepath;


    $(function() {
        var options = {
            data: list,
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            // onCheck: onCheck,
            // onUncheck: onUncheck,
            // onCheckAll: onCheckAll,
            // onUncheckAll: onUncheckAll,
            onClickRow: onClickRow,
            // onDblClickRow: onDblClickRow,
            // onClickCell: onClickCell,
            // onDblClickCell: onDblClickCell,
            responseHandler: responseHandler,
            onLoadSuccess: onLoadSuccess,
            detailView: true,
            onExpandRow : function(index, row, $detail) {
                initChildTable(index, row, $detail);
            },
            columns: [
                {
                    field : 'catalog',
                    title : '异味类型'
                },
                {
                    field : 'name',
                    title : '异味源'
                },
                {
                    title: '操作',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-success" onclick="$.operate.add()" shiro:hasPermission="system:comment:add"><i class="fa fa-plus"></i>添加评论</a>');
                        return actions.join('');
                    }
                }
                ]
        };
        $.table.init(options);
    });

    initChildTable = function(index, row, $detail) {
        var childTable = $detail.html('<table style="table-layout:fixed"></table>').find('table');
        $(childTable).bootstrapTable({
            data: list2,
            columns: [{
                field : 'authorname',
                title : '用户名'
            },
                {
                    field : 'authoremail',
                    title : '邮箱'
                },
                {
                    field : 'createtime',
                    title : '评论时间'
                },
                {
                    field : 'name',
                    title : '评论内容'
                }
                // ,
                // {
                //     title: '操作',
                //     align: 'center',
                //     formatter: function(value, row, index) {
                //         var actions = [];
                //         actions.push('<a class="btn btn-danger multiple disabled href="javascript:void(0)" onclick="$.operate.removeAll()"><i class="fa fa-remove"></i>删除评论</a>');
                //         return actions.join('');
                //     }
                // }
                ]
        });
    };


    function onClickRow(row, $element){
        for (var index in list){
            if (list[index].name == row.name)
            {
                var infoList = list[index].smellinfo.split("\n");
                var start = parseInt(infoList[0])+1;
                var end = parseInt(infoList[1])+1;
                var lineFirst = start;
                if(end==-1){
                    end = 2000;
                }
                var array = new Array();
                for(var i = start ,j=0; i <= end; i++ ,j++)
                {
                    array[j] = i;
                }
                var finalList = "["+array+"]";
                var redList = new Array();
                var blueList = new Array();
                var purpleList = new Array();

                var info="";
                if (list[index].catalog == "blob" || list[index].catalog == "long Method")
                {
                    var highlight = infoList[2];
                    var subHigh = highlight.split(";");
                    var redIndex = 0;
                    var blueIndex = 0;
                    var purpleIndex = 0;
                    var i;
                    lineFirst = parseInt(subHigh[0].split(":")[0].split("/")[0])+1;
                    for (var k=0; k<subHigh.length; k++)
                    {
                        var subsubHigh = subHigh[k].split(":");
                        var line = subsubHigh[0];
                        var catalog = subsubHigh[1];
                        var lineStart = parseInt(line.split("/")[0])+1;
                        var lineEnd = parseInt(line.split("/")[1])+1;
                        if (lineEnd == -1) lineEnd = 2000;
                        if(catalog == -1)
                        {
                            for(i = lineStart ; i <= lineEnd; i++)
                            {
                                redList[redIndex++] = i;
                            }
                        }
                        if(catalog == 1)
                        {
                            for(i = lineStart ; i <= lineEnd; i++)
                            {
                                blueList[blueIndex++] = i;
                            }
                        }
                        if(catalog == 2)
                        {
                            for(i = lineStart; i <= lineEnd; i++)
                            {
                                purpleList[purpleIndex++] = i;
                            }
                        }

                    }

                    var finalred = ";highlight3:["+redList+"]";
                    var finalblue = ";highlight1:["+blueList+"]";
                    var finalpurple = ";highlight2:["+purpleList+"]";
                    var final = finalred + finalblue + finalpurple;

                }else if(list[index].catalog == "feature Envy"){
                    info += "建议修改以下高亮代码";
                    info += "\n";
                    info = "过分依赖的类："+infoList[2]+" 可单击查看";
                    document.getElementById("filename").innerText = "提示：单击上方异味列表中的行，可查询该异味详情和重构建议。单击 表头按钮 可查看评论\n"+"异味源: "+list[index].filepath +"具体信息请留意下方提示\n"+""+'\n'+info;
                }else if(list[index].catalog == "promiscuous Package")
                {
                    if(infoList.length >= 2){
                        info += "建议修改以下类文件";
                    }
                    for (i=2; i<infoList.length; i++)
                    {
                        info += "\n";
                        info += infoList[i]+".java";
                    }
                }
                else
                {
                    info += "建议修改以下高亮代码"+"\n";
                    info += "过分依赖的包："+infoList[2];
                }

                jQuery("#codePre").html("<div><pre id='content'></pre></div>");
                jQuery("#codePre").removeAttr("style","");
                jQuery("#codePre").removeAttr("class","");
                if(list[index].catalog == "blob" || list[index].catalog == "long Method")
                {
                    $("#content").attr("class","brush: java;"+final);
                }
                else
                {
                    $("#content").attr("class","brush: java;highlight:"+finalList+final);
                }

                document.getElementById("filename").innerText = "提示：单击上方异味列表中的行，可查询该异味详情和重构建议。单击 表头按钮 可查看评论\n"+"异味源: "+list[index].filepath +"具体信息请留意下方提示\n"+""+'\n'+info;
                document.getElementById("content").innerText = list[index].content;

                if (list[index].catalog == "feature Envy")
                {
                    var c = list[index].content.split("\n<>\n");
                    document.getElementById("content").innerText = c[0];
                    document.getElementById("filename").setAttribute("href",'/system/showCode2?url='+url+'&commit='+commit+'&filePath='+infoList[2]+'&name='+list[index].name);
                    document.getElementById("filename").setAttribute("target","_blank");
                }
                if(list[0].catalog != "promiscuous Package") {
                    SyntaxHighlighter.defaults['toolbar'] = false;
                    SyntaxHighlighter.config.tagName = 'pre';       //可以更改解析的默认Tag。
                    SyntaxHighlighter.config.bloggerMode = true;
                    SyntaxHighlighter.config.stripBrs = true;
                    SyntaxHighlighter.highlight();
                    var mainContainer = $('#codeMain');
                    var scrollToContainer = $('#' + lineFirst + '');
                    window.scrollTo(0, document.documentElement.scrollHeight);
                    mainContainer.animate({
                        scrollTop: scrollToContainer.offset().top - mainContainer.offset().top + mainContainer.scrollTop()
                    }, 100);
                }else {
                    var highlight = infoList[0];
                    var subHigh = highlight.split(";");
                    var redList = new Array();
                    var blueList = new Array();
                    var purpleList = new Array();
                    var redIndex = 0;
                    var blueIndex = 0;
                    var purpleIndex = 0;
                    for (var k=0; k<subHigh.length; k++)
                    {
                        var subsubHigh = subHigh[k].split(":");
                        var fileName = subsubHigh[0];
                        var catalog = subsubHigh[1];
                        if(catalog == -1)
                        {
                            redList[redIndex++] = fileName;
                        }
                        if(catalog == 1)
                        {
                            blueList[blueIndex++] = fileName;
                        }
                        if(catalog == 2)
                        {
                            purpleList[purpleIndex++] = fileName;
                        }
                    }
                    // var obj = document.getElementById('codeMain');
                    // obj.parentNode.removeChild(obj);
                    var content = "平台已将包中的文件分为以下类别：\n";
                    if (redList.length > 0)
                    {
                        for (i=0; i<redList.length; i++)
                        {
                            content += redList[i]+"\n";
                        }
                        content += "=====================\n";
                    }
                    if (blueList.length > 0)
                    {
                        for (i=0; i<blueList.length; i++)
                        {
                            content += blueList[i]+"\n";
                        }
                        content += "=====================\n";
                    }
                    if (purpleList.length > 0)
                    {
                        for (i=0; i<purpleList.length; i++)
                        {
                            content += purpleList[i]+"\n";
                        }
                        content += "=====================\n";
                    }
                    document.getElementById("content").innerText = content;
                }
            }
        }
    }

    function responseHandler(res){
        alert("请求获取数据后处理回调函数");
    }

    function onLoadSuccess(data){
        alert("当所有数据被加载时触发");
    }

</script>
</body>
</html>